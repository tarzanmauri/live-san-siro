<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Diretta San Siro Nervi U14</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #f5f5f5;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #000;
      padding: 10px 14px;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }
    .brand span {
      color: #e50914;
    }
    .tag-cat {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 14px 10px 40px;
    }
    h2 {
      font-size: 18px;
      margin: 18px 0 10px;
    }
    .sub {
      font-size: 12px;
      color: #aaa;
    }

    /* Countdown */
    #nextMatchBox {
      background: #181818;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #262626;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .nm-title {
      font-size: 14px;
      font-weight: 600;
    }
    #countdown {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 22px;
      font-weight: 700;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #444;
    }
    .pill-live {
      border-color: #e50914;
      color: #e50914;
    }
    .pill-pre {
      border-color: #888;
      color: #bbb;
    }
    .pill-fin {
      border-color: #4caf50;
      color: #4caf50;
    }

    /* Lista partite */
    .match-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .match-card {
      background: #181818;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid #262626;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .match-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #aaa;
    }
    .match-round {
      font-weight: 600;
      color: #f5f5f5;
    }
    .teams-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 5px;
    }
    .team-name {
      font-size: 14px;
      font-weight: 500;
    }
    .team-name.sansiro {
      color: #fff;
      font-weight: 700;
    }
    .score {
      font-size: 20px;
      font-weight: 700;
      min-width: 60px;
      text-align: center;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #888;
    }
    .btn-small {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #222;
      color: #eee;
      cursor: pointer;
    }
    .btn-small:hover {
      background: #333;
    }

    /* Top marcatori */
    #topScorersBox {
      background: #181818;
      border-radius: 10px;
      border: 1px solid #262626;
      padding: 10px 12px;
      font-size: 14px;
    }
    .ts-row {
      padding: 5px 0;
      border-bottom: 1px solid #262626;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .ts-name {
      font-weight: 600;
    }
    .ts-num {
      font-size: 12px;
      color: #ccc;
      white-space: nowrap;
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: #666;
      padding: 10px 0 18px;
    }

    /* MATCH CENTER */
    #matchCenter {
      display: none;
      max-width: 900px;
      margin: 0 auto;
      padding: 14px 10px 40px;
    }
    .back-btn {
      margin-bottom: 10px;
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      background: #e50914;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .box {
      background: #181818;
      border-radius: 10px;
      border: 1px solid #262626;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .mc-title {
      font-size: 18px;
      font-weight: 700;
      margin: 4px 0 2px;
    }
    .mc-score {
      font-size: 22px;
      font-weight: 800;
      margin: 4px 0 6px;
    }
    .mc-line {
      font-size: 13px;
      color: #ccc;
    }
    .evt-row {
      padding: 4px 0;
      border-bottom: 1px solid #262626;
      font-size: 13px;
    }

    /* Voti & MVP */
    .rating-row {
      padding: 5px 0;
      border-bottom: 1px solid #262626;
      font-size: 14px;
    }
    .rating-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .rating-dots span {
      display: inline-block;
      margin-right: 4px;
      margin-bottom: 2px;
      padding: 2px 5px;
      border-radius: 6px;
      border: 1px solid #444;
      font-size: 12px;
      cursor: pointer;
    }
    .rating-dots span.active {
      background: #e5c14d;
      color: #000;
      border-color: #e5c14d;
      font-weight: 700;
    }
    .mvp-btn {
      width: 100%;
      margin-bottom: 6px;
      padding: 7px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .mvp-btn.selected {
      background: #e5c14d;
      color: #000;
      font-weight: 700;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">DIRETTA <span>SAN SIRO</span> U14</div>
  <div class="tag-cat">Campionato 2025/26</div>
</header>

<main id="mainPage">
  <h2>Prossima partita</h2>
  <div id="nextMatchBox">
    <div class="nm-title" id="nextMatchInfo">Caricamento…</div>
    <div id="countdown">--:--:--</div>
    <div id="nextMatchStatus" class="sub"></div>
  </div>

  <h2>Partite U14</h2>
  <div class="sub" style="margin-bottom:6px;">
    Tocca su <b>Match Center</b> per vedere cronaca, marcatori, voti e MVP.
  </div>
  <div id="matchesList" class="match-list"></div>

  <h2>Classifica marcatori</h2>
  <div id="topScorersBox">Caricamento…</div>
</main>

<div id="matchCenter">
  <button class="back-btn" onclick="closeMatchCenter()">← Torna alle partite</button>

  <div class="box">
    <div class="mc-title" id="mcTitle"></div>
    <div class="mc-score" id="mcScore"></div>
    <div class="mc-line" id="mcInfo"></div>
    <div class="mc-line" id="mcTimer"></div>
  </div>

  <div class="box">
    <b>Marcatori San Siro</b>
    <div id="mcGoalsHome"></div>
    <hr style="border:none;border-top:1px solid #262626;margin:6px 0;">
    <b>Marcatori Avversari</b>
    <div id="mcGoalsAway"></div>
  </div>

  <div class="box">
    <b>Assist</b>
    <div id="mcAssists"></div>
  </div>

  <div class="box">
    <b>Formazione iniziale</b>
    <div id="mcLineup"></div>
    <hr style="border:none;border-top:1px solid #262626;margin:6px 0;">
    <b>Panchina</b>
    <div id="mcBench"></div>
  </div>

  <div class="box">
    <b>Cronaca</b>
    <div id="mcEvents"></div>
  </div>

  <div class="box">
    <b>Voti giocatori</b>
    <div id="mcRatings"></div>
    <div style="font-size:11px;color:#999;margin-top:4px;">
      Ogni dispositivo può esprimere un voto per giocatore (salvato solo in questo browser).
    </div>
  </div>

  <div class="box">
    <b>MVP del match</b>
    <div id="mcMvp"></div>
  </div>
</div>

<footer>
  Diretta San Siro Nervi U14 – versione senza server, dati gestiti in locale dal mister
</footer>

<script>
  /* ===============================
     CONFIG DATI DI BASE
  =============================== */
  const STORAGE_KEY = "ssn_matches_v2";

  function defaultLineup() {
    return {
      starting: [
        "1 - Micucci Emanuele (POR)",
        "6 - Maro Terenui Luca (DC)",
        "11 - Rebaudengo Amedeo (TS)",
        "25 - Panebianco Edoardo (TD)",
        "8 - Vitarelli Alessandro (TRQ)",
        "4 - Meazzi Timoteo (TRQ)",
        "10 - Ronda Rocco (FW)"
      ],
      bench: [
        "99 - Vitarelli Andrea",
        "12 - Perez Sanabria Erik Joshue",
        "5 - Risso Leonardo",
        "35 - Buzzi Diego",
        "7 - Lanini Gabriele",
        "4 - Cerfogli Elio"
      ]
    };
  }

  const baseMatches = [
    {
      id: 1,
      round: "1ª giornata",
      dateTime: "2025-10-18T10:00:00",
      category: "U14",
      field: "Campo Meja",
      homeTeam: "San Marziano",
      awayTeam: "San Siro Nervi U14",
      homeScore: 1,
      awayScore: 1,
      status: "FIN",
      seconds: 0,
      goals: [
        { team: "away", name: "Edoardo Panebianco", goals: 1 }
      ],
      assists: [
        { team: "away", name: "Meazzi Timoteo", assists: 1 }
      ],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 2,
      round: "2ª giornata",
      dateTime: "2025-10-26T16:30:00",
      category: "U14",
      field: "Campo Emiliani",
      homeTeam: "San Siro Nervi U14",
      awayTeam: "Fulgor Gialli U14",
      homeScore: 8,
      awayScore: 1,
      status: "FIN",
      seconds: 0,
      goals: [
        { team: "home", name: "Meazzi Timoteo", goals: 5 },
        { team: "home", name: "Ronda Rocco", goals: 1 },
        { team: "home", name: "Rebaudengo Amedeo", goals: 1 },
        { team: "home", name: "Vitarelli Andrea", goals: 1 }
      ],
      assists: [
        { team: "home", name: "Buzzi Diego", assists: 1 },
        { team: "home", name: "Vitarelli Alessandro", assists: 2 },
        { team: "home", name: "Rebaudengo Amedeo", assists: 3 }
      ],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 3,
      round: "3ª giornata",
      dateTime: "2025-11-09T10:00:00",
      category: "U14",
      field: "Sestri Ponente",
      homeTeam: "San Giovanni Battista U14",
      awayTeam: "San Siro Nervi U14",
      homeScore: 5,
      awayScore: 6,
      status: "FIN",
      seconds: 0,
      goals: [
        { team: "away", name: "Ronda Rocco", goals: 4 },
        { team: "away", name: "Vitarelli Andrea", goals: 1 },
        { team: "away", name: "Vitarelli Alessandro", goals: 1 }
      ],
      assists: [
        { team: "away", name: "Lanini Gabriele", assists: 1 },
        { team: "away", name: "Vitarelli Alessandro", assists: 1 },
        { team: "away", name: "Rebaudengo Amedeo", assists: 1 }
      ],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 4,
      round: "4ª giornata",
      dateTime: "2025-11-23T16:30:00",
      category: "U14",
      field: "Campo Emiliani",
      homeTeam: "San Siro Nervi U14",
      awayTeam: "Genova SC Albaro",
      homeScore: null,
      awayScore: null,
      status: "PRE",
      seconds: 0,
      goals: [],
      assists: [],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 5,
      round: "5ª giornata",
      dateTime: "2025-11-30T10:30:00",
      category: "U14",
      field: "Campo Fumeri",
      homeTeam: "Fulgor Verdi U14",
      awayTeam: "San Siro Nervi U14",
      homeScore: null,
      awayScore: null,
      status: "PRE",
      seconds: 0,
      goals: [],
      assists: [],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 6,
      round: "6ª giornata (riposo)",
      dateTime: "2025-12-14T00:00:00",
      category: "U14",
      field: "Riposo",
      homeTeam: "San Siro Nervi U14",
      awayTeam: "—",
      homeScore: null,
      awayScore: null,
      status: "PRE",
      seconds: 0,
      goals: [],
      assists: [],
      events: [],
      lineup: defaultLineup()
    },
    {
      id: 7,
      round: "7ª giornata",
      dateTime: "2025-12-21T16:30:00",
      category: "U14",
      field: "Campo Emiliani",
      homeTeam: "San Siro Nervi U14",
      awayTeam: "Polisportiva Pieve",
      homeScore: null,
      awayScore: null,
      status: "PRE",
      seconds: 0,
      goals: [],
      assists: [],
      events: [],
      lineup: defaultLineup()
    }
  ];

  function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function loadMatches() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return deepClone(baseMatches);
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || !parsed.length) return deepClone(baseMatches);
      return parsed;
    } catch (e) {
      return deepClone(baseMatches);
    }
  }

  function saveMatches(matches) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
  }

  let matches = loadMatches();
  let lastSnapshot = localStorage.getItem(STORAGE_KEY) || "";
  let countdownInterval = null;
  let currentMatchCenterId = null;

  function formatDateTime(dtStr) {
    const d = new Date(dtStr);
    if (Number.isNaN(d.getTime())) return dtStr;
    const gg = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${gg}/${mm}/${d.getFullYear()} • ${hh}:${mi}`;
  }

  function formatCountdown(diffMs) {
    let totalSeconds = Math.max(0, Math.floor(diffMs / 1000));
    const hh = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
    totalSeconds %= 3600;
    const mm = String(Math.floor(totalSeconds / 60)).padStart(2,"0");
    const ss = String(totalSeconds % 60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }

  function formatTimer(seconds) {
    const s = seconds || 0;
    const mm = String(Math.floor(s / 60)).padStart(2,"0");
    const ss = String(s % 60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  function statusLabel(m) {
    if (m.status === "FIN") return "Terminata";
    if (m.status === "PRE") return "In programma";
    if (m.status === "LIVE") return "LIVE";
    return m.status || "";
  }

  function statusClass(m) {
    if (m.status === "FIN") return "pill pill-fin";
    if (m.status === "LIVE") return "pill pill-live";
    return "pill pill-pre";
  }

  function getNextMatch() {
    const now = new Date();
    const upcoming = matches
      .map(m => ({...m, dt: new Date(m.dateTime)}))
      .filter(m => m.status === "PRE" && m.dt.getTime() > now.getTime())
      .sort((a,b) => a.dt - b.dt);
    return upcoming[0] || null;
  }

  function renderCountdown() {
    const box = document.getElementById("nextMatchBox");
    const info = document.getElementById("nextMatchInfo");
    const cd = document.getElementById("countdown");
    const st = document.getElementById("nextMatchStatus");

    if (countdownInterval) clearInterval(countdownInterval);

    const next = getNextMatch();

    if (!next) {
      info.textContent = "Nessuna partita in programma.";
      cd.textContent = "--:--:--";
      st.innerHTML = "";
      return;
    }

    const dt = new Date(next.dateTime);
    info.textContent = `${next.round} • ${next.homeTeam} vs ${next.awayTeam} (${formatDateTime(next.dateTime)})`;

    function update() {
      const copy = matches.find(m => m.id === next.id) || next;
      if (copy.status === "LIVE") {
        cd.textContent = "CALCIO D'INIZIO!";
        st.innerHTML = `<span class="pill pill-live">LIVE</span>`;
        clearInterval(countdownInterval);
        return;
      }
      if (copy.status === "FIN") {
        cd.textContent = "PARTITA TERMINATA";
        st.innerHTML = `<span class="pill pill-fin">Terminata</span>`;
        clearInterval(countdownInterval);
        return;
      }

      const now = new Date();
      const diff = dt - now;
      if (diff <= 0) {
        cd.textContent = "Pronta a partire…";
        st.innerHTML = `<span class="pill pill-pre">Calcio d'inizio previsto alle ${formatDateTime(next.dateTime).split("•")[1].trim()}</span>`;
        return;
      }

      cd.textContent = formatCountdown(diff);
      st.innerHTML = `<span class="pill pill-pre">Mancano</span>`;
    }

    update();
    countdownInterval = setInterval(update, 1000);
  }

  function renderMatches() {
    const container = document.getElementById("matchesList");
    container.innerHTML = "";
    matches
      .slice()
      .sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime))
      .forEach(m => {
        const card = document.createElement("div");
        card.className = "match-card";

        const scoreText =
          (m.homeScore === null || m.homeScore === undefined ||
           m.awayScore === null || m.awayScore === undefined)
          ? "- : -"
          : `${m.homeScore} - ${m.awayScore}`;

        card.innerHTML = `
          <div class="match-header">
            <div>
              <div class="match-round">${m.round}</div>
              <div>${formatDateTime(m.dateTime)}</div>
              <div>${m.field}</div>
            </div>
            <button class="btn-small" onclick="openMatchCenter(${m.id})">
              Match Center
            </button>
          </div>
          <div class="teams-row">
            <div class="team-name sansiro">${m.homeTeam}</div>
            <div class="score">${scoreText}</div>
            <div class="team-name">${m.awayTeam}</div>
          </div>
          <div class="status-row">
            <div class="${statusClass(m)}">${statusLabel(m)}</div>
            <div>
              <span style="margin-right:8px;">Timer: ${formatTimer(m.seconds||0)}</span>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
  }

  function renderTopScorers() {
    const box = document.getElementById("topScorersBox");
    const map = {};

    matches.forEach(m => {
      (m.goals || []).forEach(g => {
        if (!map[g.name]) map[g.name] = { goals: 0, assists: 0 };
        map[g.name].goals += g.goals || 0;
      });
      (m.assists || []).forEach(a => {
        if (!map[a.name]) map[a.name] = { goals: 0, assists: 0 };
        map[a.name].assists += a.assists || 0;
      });
    });

    const arr = Object.keys(map).map(name => ({
      name,
      goals: map[name].goals,
      assists: map[name].assists
    })).filter(p => p.goals > 0 || p.assists > 0);

    if (!arr.length) {
      box.textContent = "Ancora nessun marcatore registrato.";
      return;
    }

    arr.sort((a,b) => {
      if (b.goals !== a.goals) return b.goals - a.goals;
      return b.assists - a.assists;
    });

    box.innerHTML = "";
    arr.forEach(p => {
      const row = document.createElement("div");
      row.className = "ts-row";
      row.innerHTML = `
        <span class="ts-name">${p.name}</span>
        <span class="ts-num">Gol: ${p.goals} • Assist: ${p.assists}</span>
      `;
      box.appendChild(row);
    });
  }

  function openMatchCenter(id) {
    const m = matches.find(x => x.id === id);
    if (!m) return;
    currentMatchCenterId = id;

    document.getElementById("mainPage").style.display = "none";
    document.getElementById("matchCenter").style.display = "block";

    document.getElementById("mcTitle").textContent =
      `${m.homeTeam} vs ${m.awayTeam}`;
    const scoreText =
      (m.homeScore === null || m.homeScore === undefined ||
       m.awayScore === null || m.awayScore === undefined)
      ? "- : -"
      : `${m.homeScore} - ${m.awayScore}`;
    document.getElementById("mcScore").textContent = scoreText;
    document.getElementById("mcInfo").textContent =
      `${m.round} • ${formatDateTime(m.dateTime)} • ${m.field}`;
    document.getElementById("mcTimer").textContent =
      `Stato: ${statusLabel(m)} • Timer: ${formatTimer(m.seconds||0)}`;

    // Marcatori
    const homeGoals = (m.goals || []).filter(g => g.team === "home");
    const awayGoals = (m.goals || []).filter(g => g.team === "away");
    document.getElementById("mcGoalsHome").innerHTML =
      homeGoals.length
        ? homeGoals.map(g => `${g.name} (${g.goals})`).join("<br>")
        : "—";
    document.getElementById("mcGoalsAway").innerHTML =
      awayGoals.length
        ? awayGoals.map(g => `${g.name} (${g.goals})`).join("<br>")
        : "—";

    // Assist
    const assists = m.assists || [];
    document.getElementById("mcAssists").innerHTML =
      assists.length
        ? assists.map(a => `${a.name} (${a.assists})`).join("<br>")
        : "—";

    // Formazioni
    const lu = m.lineup || defaultLineup();
    document.getElementById("mcLineup").innerHTML =
      (lu.starting || []).map(p => p).join("<br>") || "—";
    document.getElementById("mcBench").innerHTML =
      (lu.bench || []).map(p => p).join("<br>") || "—";

    // Cronaca
    const evts = m.events || [];
    document.getElementById("mcEvents").innerHTML =
      evts.length
        ? evts.map(e => `<div class="evt-row"><b>${e.minute}'</b> — ${e.text}</div>`).join("")
        : "<i style='color:#999;'>Ancora nessuna azione registrata.</i>";

    renderRatingsSection(m);
    renderMvpSection(m);
  }

  function closeMatchCenter() {
    document.getElementById("matchCenter").style.display = "none";
    document.getElementById("mainPage").style.display = "block";
    currentMatchCenterId = null;
  }

  /* VOTI */
  function ratingKey(matchId, playerName) {
    return `rate_${matchId}_${playerName}`;
  }
  function getStoredRating(matchId, playerName) {
    const v = localStorage.getItem(ratingKey(matchId,playerName));
    return v ? Number(v) : null;
  }
  function setStoredRating(matchId, playerName, value) {
    localStorage.setItem(ratingKey(matchId,playerName), String(value));
  }

  function renderRatingsSection(match) {
    const box = document.getElementById("mcRatings");
    const lu = match.lineup || defaultLineup();
    const players = lu.starting || [];
    if (!players.length) {
      box.textContent = "Formazione non disponibile.";
      return;
    }
    const rows = players.map(p => {
      const clean = p.replace(/^\d+\s*-\s*/, "");
      const stored = getStoredRating(match.id, clean);
      let dots = "";
      for (let i = 5; i <= 10; i++) {
        const cls = stored === i ? "active" : "";
        dots += `<span class="${cls}" onclick="votePlayer(${match.id}, '${clean.replace(/'/g,"\\'")}', ${i}, this)">${i}</span>`;
      }
      return `
        <div class="rating-row">
          <div class="rating-name">${clean}</div>
          <div class="rating-dots">${dots}</div>
        </div>
      `;
    }).join("");
    box.innerHTML = rows;
  }

  function votePlayer(matchId, playerName, value, el) {
    setStoredRating(matchId, playerName, value);
    // refresh only this row
    openMatchCenter(matchId);
    alert("Voto registrato!");
  }

  /* MVP */
  function mvpKey(matchId) {
    return `mvp_${matchId}`;
  }
  function getStoredMvp(matchId) {
    return localStorage.getItem(mvpKey(matchId));
  }
  function setStoredMvp(matchId, playerName) {
    localStorage.setItem(mvpKey(matchId), playerName);
  }

  function renderMvpSection(match) {
    const box = document.getElementById("mcMvp");
    const lu = match.lineup || defaultLineup();
    const players = lu.starting || [];
    if (!players.length) {
      box.textContent = "Formazione non disponibile.";
      return;
    }
    const selected = getStoredMvp(match.id);
    box.innerHTML = players.map(p => {
      const cls = (selected === p) ? "mvp-btn selected" : "mvp-btn";
      return `<button class="${cls}" onclick="selectMvp(${match.id}, '${p.replace(/'/g,"\\'")}')">${p}</button>`;
    }).join("");
  }

  function selectMvp(matchId, playerName) {
    setStoredMvp(matchId, playerName);
    openMatchCenter(matchId);
    alert("MVP selezionato!");
  }

  function renderAll() {
    renderCountdown();
    renderMatches();
    renderTopScorers();
    if (currentMatchCenterId != null) {
      openMatchCenter(currentMatchCenterId);
    }
  }

  // Poll locale: se l'admin aggiorna i dati in un'altra tab dello STESSO browser
  function pollStorage() {
    const current = localStorage.getItem(STORAGE_KEY) || "";
    if (current !== lastSnapshot) {
      lastSnapshot = current;
      try {
        matches = JSON.parse(current);
      } catch (e) {
        matches = loadMatches();
      }
      renderAll();
    }
  }

  // Init
  window.addEventListener("load", () => {
    matches = loadMatches();
    lastSnapshot = localStorage.getItem(STORAGE_KEY) || "";
    renderAll();
    setInterval(pollStorage, 3000);
  });
</script>
</body>
</html>
